import telebot
from telebot.types import InlineKeyboardButton, InlineKeyboardMarkup
import random

# Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð²Ð°Ñˆ Ñ‚Ð¾ÐºÐµÐ½
TOKEN = '7383941068:AAELJkcVfnKOj8voO5BafNjvfcQLnF-BWvk'
bot = telebot.TeleBot(TOKEN)


def create_empty_board(size=8):
    return [[' ' for _ in range(size)] for _ in range(size)]


def place_ships(board, ship_count=20):
    size = len(board)
    placed_ships = 0

    while placed_ships < ship_count:
        row = random.randint(0, size - 1)
        col = random.randint(0, size - 1)

        if board[row][col] == ' ':
            board[row][col] = 'O'
            placed_ships += 1

    return board


# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¸Ð³Ñ€Ð¾Ð²Ð¾Ð³Ð¾ Ð¿Ð¾Ð»Ñ 9x9
def create_game_board(board):
    markup = InlineKeyboardMarkup(row_width=8)
    buttons = []
    for row in range(len(board)):
        for col in range(len(board[row])):
            text = board[row][col]
            if text == ' ':
                text = f'{row},{col}'  # ÐŸÐ¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ Ñ‚ÐµÐºÑÑ‚ ÐºÐ½Ð¾Ð¿ÐºÐ¸ - ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ‚Ñ‹
            elif text == '0':
                text = 'ðŸŸ¥'  # Ð–ÐµÐ»Ñ‚Ñ‹Ð¹ ÐºÐ²Ð°Ð´Ñ€Ð°Ñ‚ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð¼Ð°Ñ…Ð°
            elif text == 'x':
                text = 'ðŸŸ©'  # Ð—ÐµÐ»ÐµÐ½Ñ‹Ð¹ ÐºÐ²Ð°Ð´Ñ€Ð°Ñ‚ Ð´Ð»Ñ Ð¿Ð¾Ð¿Ð°Ð´Ð°Ð½Ð¸Ñ
            buttons.append(InlineKeyboardButton(text, callback_data=f'{row},{col}'))
    markup.row(InlineKeyboardButton("ÐŸÐ¾ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ Ñ„Ð»Ð°Ð³", callback_data="flag"))

    for i in range(0, len(buttons), 8):
        markup.row(*buttons[i:i + 8])
    return markup


# ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /start
@bot.message_handler(commands=['start'])
def start(message):
    global otvety, board, hits_count
    board_with_ships = create_empty_board()
    otvety = place_ships(board_with_ships)
    hits_count = 0

    # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿ÑƒÑÑ‚Ð¾Ðµ Ð¸Ð³Ñ€Ð¾Ð²Ð¾Ðµ Ð¿Ð¾Ð»Ðµ Ð´Ð»Ñ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ ÐµÐ³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ
    board = create_empty_board()
    board_markup = create_game_board(board)
    bot.send_message(message.chat.id, "Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ Ð² Ð¸Ð³Ñ€Ñƒ 'ÐœÐ¾Ñ€ÑÐºÐ¾Ð¹ Ð±Ð¾Ð¹'!", reply_markup=board_markup)


@bot.callback_query_handler(func=lambda call: call.data == 'flag')
def handle_flag_query(call):
    try:
        bot.send_message(call.message.chat.id,
                         f"Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ‚Ñ‹ ÐºÐ»ÐµÑ‚ÐºÐ¸ Ð´Ð»Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ñ„Ð»Ð°Ð³Ð° Ð² Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ 'ÑÑ‚Ñ€Ð¾ÐºÐ°,ÑÑ‚Ð¾Ð»Ð±ÐµÑ†' (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, 1,1):")

        # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð´Ð»Ñ Ð²Ð²Ð¾Ð´Ð° ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ‚
        bot.register_next_step_handler(call.message, process_flag_input)

    except Exception as e:
        print(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° Ð½Ð° Ð¿Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÑƒ Ñ„Ð»Ð°Ð³Ð°: {e}")


# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð²Ð²Ð¾Ð´Ð° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
def process_flag_input(message):
    try:
        # ÐŸÐ°Ñ€ÑÐ¸Ð¼ Ð²Ð²ÐµÐ´ÐµÐ½Ð½Ñ‹Ðµ ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ‚Ñ‹
        row, col = map(int, message.text.split(','))

        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð²Ð²ÐµÐ´ÐµÐ½Ð½Ñ‹Ðµ ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ‚Ñ‹ Ð½Ð°Ñ…Ð¾Ð´ÑÑ‚ÑÑ Ð² Ð¿Ñ€ÐµÐ´ÐµÐ»Ð°Ñ… Ð¸Ð³Ñ€Ð¾Ð²Ð¾Ð³Ð¾ Ð¿Ð¾Ð»Ñ
        if 0 <= row < len(board) and 0 <= col < len(board[0]):

            board[row][col] = 'ðŸš©'  # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÐ¼Ð¾Ð´Ð·Ð¸ Ñ„Ð»Ð°Ð³Ð°
                
        else:
            bot.send_message(message.chat.id, "ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ðµ ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ‚Ñ‹. Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ‡Ð¸ÑÐ»Ð° Ð² Ð´Ð¾Ð¿ÑƒÑÑ‚Ð¸Ð¼Ð¾Ð¼ Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½Ðµ.")

    except ValueError:
        bot.send_message(message.chat.id, "ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ‚. Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ‡Ð¸ÑÐ»Ð° Ñ‡ÐµÑ€ÐµÐ· Ð·Ð°Ð¿ÑÑ‚ÑƒÑŽ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, 1,1).")
    except Exception as e:
        print(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ Ð²Ð²Ð¾Ð´Ð° ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ‚: {e}")


# ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð½Ð°Ð¶Ð°Ñ‚Ð¸Ð¹ Ð½Ð° ÐºÐ½Ð¾Ð¿ÐºÐ¸
@bot.callback_query_handler(func=lambda call: True)
def handle_query(call):
    global otvety, board, hits_count
    if call.data == 'flag':
        return
    row, col = map(int, call.data.split(','))

    if otvety[row][col] == 'O':
        board[row][col] = 'x'
        hits_count += 1
        bot.answer_callback_query(call.id, f"Ð²Ñ‹ Ð¿Ð¾Ð¿Ð°Ð»Ð¸ {row},{col}")
    elif otvety[row][col] == ' ':
        board[row][col] = '0'
        bot.answer_callback_query(call.id, f"Ð²Ñ‹ Ð¿Ñ€Ð¸Ð¼Ð¾Ñ…Ð½ÑƒÐ»Ð¸ÑÑŒ     {row},{col}")

    new_board = create_game_board(board)
    bot.edit_message_reply_markup(call.message.chat.id, call.message.message_id, reply_markup=new_board)

    if hits_count == 20:
        bot.send_message(call.message.chat.id, "ÐŸÐ¾Ð·Ð´Ñ€Ð°Ð²Ð»ÑÑŽ, Ð²Ñ‹ Ð²Ñ‹Ð¸Ð³Ñ€Ð°Ð»Ð¸! Ð§Ñ‚Ð¾Ð±Ñ‹ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ Ð½Ð¾Ð²ÑƒÑŽ Ð¸Ð³Ñ€Ñƒ, Ð²Ð²ÐµÐ´Ð¸Ñ‚Ðµ /start.")






# Ð—Ð°Ð¿ÑƒÑÐº Ð±Ð¾Ñ‚Ð°
bot.polling(none_stop=True)
