import telebot
from telebot.types import InlineKeyboardButton, InlineKeyboardMarkup
import random

# Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð²Ð°Ñˆ Ñ‚Ð¾ÐºÐµÐ½
TOKEN = '7383941068:AAELJkcVfnKOj8voO5BafNjvfcQLnF-BWvk'
bot = telebot.TeleBot(TOKEN)


def create_empty_board(size=8):
    return [[' ' for _ in range(size)] for _ in range(size)]


def place_ships(board, ship_count=15):
    size = len(board)
    placed_ships = 0

    while placed_ships < ship_count:
        row = random.randint(0, size - 1)
        col = random.randint(0, size - 1)

        if board[row][col] == ' ':
            board[row][col] = 'O'
            placed_ships += 1

    return board

def check_win():
    global otvety, board
    for row in range(len(board)):
        for col in range(len(board[row])):
            if otvety[row][col] == 'O' and board[row][col] != 'ðŸš©':
                return False
    return True

def count_ships_around(row, col, board):
    count = 0
    size = len(board)
    for r in range(max(0, row - 1), min(size, row + 2)):
        for c in range(max(0, col - 1), min(size, col + 2)):
            if board[r][c] == 'O' and (r != row or c != col):
                count += 1
    return str(count)


def create_game_board(board):
    markup = InlineKeyboardMarkup(row_width=8)
    buttons = []
    for row in range(len(board)):
        for col in range(len(board[row])):
            text = board[row][col]
            if text == ' ':
                text = f'{row},{col}'
            elif text == 'x':
                text = 'ðŸ’£'
            elif text == '1':
                text = '1ï¸âƒ£'
            elif text == '2':
                text = '2ï¸âƒ£'
            elif text == '3':
                text = '3ï¸âƒ£'
            elif text == '4':
                text = '4ï¸âƒ£'
            elif text == '5':
                text = '5ï¸âƒ£'
            elif text == '6':
                text = '6ï¸âƒ£'
            elif text == '7':
                text = '7ï¸âƒ£'
            elif text == '0':
                text = '0ï¸âƒ£'
            buttons.append(InlineKeyboardButton(text, callback_data=f'{row},{col}'))
    markup.row(InlineKeyboardButton("ÐŸÐ¾ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ Ñ„Ð»Ð°Ð³", callback_data="flag"))

    for i in range(0, len(buttons), 8):
        markup.row(*buttons[i:i + 8])
    return markup


@bot.message_handler(commands=['start'])
def start(message):
    global otvety, board, hits_count, game_active
    try:
        bot.delete_message(message.chat.id, message.message_id - 2)
    except:
        pass
    board_with_ships = create_empty_board()
    otvety = place_ships(board_with_ships)
    hits_count = 0
    game_active = True
    board = create_empty_board()
    board_markup = create_game_board(board)
    bot.send_message(message.chat.id, "Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ Ð² Ð¸Ð³Ñ€Ñƒ 'ÐœÐ¾Ñ€ÑÐºÐ¾Ð¹ Ð±Ð¾Ð¹'!", reply_markup=board_markup)


@bot.callback_query_handler(func=lambda call: call.data == 'flag')
def handle_flag_query(call):
    try:
        bot.send_message(call.message.chat.id,
                         f"Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ‚Ñ‹ ÐºÐ»ÐµÑ‚ÐºÐ¸ Ð´Ð»Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ñ„Ð»Ð°Ð³Ð° Ð² Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ 'ÑÑ‚Ñ€Ð¾ÐºÐ°,ÑÑ‚Ð¾Ð»Ð±ÐµÑ†' (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, 1,1):")

        bot.register_next_step_handler(call.message, process_flag_input)

    except Exception as e:
        print(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° Ð½Ð° Ð¿Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÑƒ Ñ„Ð»Ð°Ð³Ð°: {e}")


def process_flag_input(message):
    flag_count = 0
    try:
        row, col = map(int, message.text.split(','))

        if 0 <= row < len(board) and 0 <= col < len(board[0]):

            board[row][col] = 'ðŸš©'
            flag_count += 1
            new_board = create_game_board(board)
            bot.delete_message(message.chat.id, message.message_id)
            bot.delete_message(message.chat.id, message.message_id - 1)

            bot.edit_message_text('Ð¤Ð»Ð°Ð³ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¿Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½', message.chat.id, message.message_id - 2,
                                  reply_markup=new_board)

        else:
            bot.send_message(message.chat.id, "ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ðµ ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ‚Ñ‹. Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ‡Ð¸ÑÐ»Ð° Ð² Ð´Ð¾Ð¿ÑƒÑÑ‚Ð¸Ð¼Ð¾Ð¼ Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½Ðµ.")

        if flag_count == 15:
            if check_win():
                bot.send_message(message.chat.id, "ÐŸÐ¾Ð·Ð´Ñ€Ð°Ð²Ð»ÑÑŽ, Ð²Ñ‹ Ð²Ñ‹Ð¸Ð³Ñ€Ð°Ð»Ð¸! Ð§Ñ‚Ð¾Ð±Ñ‹ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ Ð½Ð¾Ð²ÑƒÑŽ Ð¸Ð³Ñ€Ñƒ, Ð²Ð²ÐµÐ´Ð¸Ñ‚Ðµ /start.")
            else:
                bot.send_message(message.chat.id,
                                 "Ð’Ñ‹ Ð¿Ñ€Ð¾Ð¸Ð³Ñ€Ð°Ð»Ð¸! ÐÐµ Ð²ÑÐµ Ñ„Ð»Ð°Ð³Ð¸ ÑÑ‚Ð¾ÑÑ‚ Ð½Ð° Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ñ… Ð¼ÐµÑÑ‚Ð°Ñ…. Ð§Ñ‚Ð¾Ð±Ñ‹ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ Ð½Ð¾Ð²ÑƒÑŽ Ð¸Ð³Ñ€Ñƒ, Ð²Ð²ÐµÐ´Ð¸Ñ‚Ðµ /start.")

    except ValueError:
        bot.send_message(message.chat.id, "ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ‚. Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ‡Ð¸ÑÐ»Ð° Ñ‡ÐµÑ€ÐµÐ· Ð·Ð°Ð¿ÑÑ‚ÑƒÑŽ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, 1,1).")
    except Exception as e:
        print(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ Ð²Ð²Ð¾Ð´Ð° ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ‚: {e}")


@bot.callback_query_handler(func=lambda call: True)
def handle_query(call):
    global otvety, board, hits_count, game_active
    if not game_active:
        return
    if call.data == 'flag':
        return
    if call.data == 'ðŸš©':
        return
    row, col = map(int, call.data.split(','))
    try:
        if otvety[row][col] == 'O':
            board[row][col] = 'x'
            game_active = False
            bot.send_message(call.message.chat.id, "Ð’Ñ‹ Ð¿Ñ€Ð¾Ð¸Ð³Ñ€Ð°Ð»Ð¸! Ð§Ñ‚Ð¾Ð±Ñ‹ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ Ð½Ð¾Ð²ÑƒÑŽ Ð¸Ð³Ñ€Ñƒ, Ð²Ð²ÐµÐ´Ð¸Ñ‚Ðµ /start.")
            hits_count += 1
            bot.answer_callback_query(call.id, f"Ð²Ñ‹ Ð¿Ð¾Ð¿Ð°Ð»Ð¸ {row},{col}")
        elif otvety[row][col] == ' ':
            board[row][col] = count_ships_around(row, col, otvety)
    except:
        pass

    new_board = create_game_board(board)
    bot.edit_message_reply_markup(call.message.chat.id, call.message.message_id, reply_markup=new_board)



bot.polling(none_stop=True)
